<!DOCTYPE html>
<html lang="zh-hk">
	<head>
		<title>Speech Recognition 0.0.1</title>
		<meta charset="UTF-8"/>
		<script>
function convertToPunctuation(string){
	var punctuations = {
		"斷行號": "\n",
		"逗號": "，",
		"句號": "。",
		"頓號": "、",
		"冒號": "：",
		"分號": "；",
		"問號": "？",
		"感嘆號": "！",
		"破折號": "——",
		"省略號": "……",
		"開括號": "（",
		"關括號": "）",
		"開引號": "「",
		"關引號": "」",
		"開雙引號": "『",
		"關雙引號": "』",
		"開書名號": "《",
		"關書名號": "》"
	};
	for (var i in punctuations){
		string = string.split(i).join(punctuations[i]);
	}
	return string;
}

var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
var speechRecognition = null;

window.addEventListener("load", function(){
	if (SpeechRecognition){
		speechRecognition = new SpeechRecognition();
		speechRecognition.continuous = true;
		speechRecognition.interimResults = true;
		speechRecognition.addEventListener("start", function(){
		});
		speechRecognition.addEventListener("result", function(event){
			console.log(event);
			speechRecognition.lang = document.getElementById("language").value;
			var bufferContainer = document.getElementById("bufferContainer");
			var resultContainer = document.getElementById("resultContainer");
			for (var i in event.results){
				try{
					var result = event.results[i];
					var text = convertToPunctuation(result[0].transcript);
					if (result.isFinal){
						this.stop();
						resultContainer.innerHTML = bufferContainer.innerHTML;
					} else {
						bufferContainer.innerHTML = resultContainer.innerHTML + text;
					}
				} catch (ex){
				}
			}
		});
		speechRecognition.addEventListener("end", function(){
			var toggle = document.getElementById("toggle");
			var autoResume = document.getElementById("autoResume");
			if (toggle.value == "停止語音辨認輸入" && autoResume.checked){
				this.start();
				console.log(new Date());
			}
		});
	}
});

function toggleSpeechRecognition(){
	var toggle = document.getElementById("toggle");
	if (toggle.value == "停止語音辨認輸入"){
		speechRecognition.lang = document.getElementById("language").value;
		toggle.value = "啟動語音辨認輸入";
		speechRecognition.stop();
	} else {
		toggle.value = "停止語音辨認輸入";
		speechRecognition.start();
	}
}

function selectAllText(element){
	element.select();
}
</script>
	</head>
	<body>
		<select id="language">
			<option value="yue-Hant-HK">香港粵語</option>
			<option value="en-US">美式英語</option>
		</select>
		<label>連續執行<input id="autoResume" type="checkbox" checked="checked"/></label>
		<input id="toggle" type="button" value="啟動語音辨認輸入" onclick="toggleSpeechRecognition();"/>
		<table width="100%">
			<colgroup>
				<col width="50%"/>
				<col width="50%"/>
			</colgroup>
			<thead>
				<tr>
					<th><input type="button" value="全選暫存文字" onclick="selectAllText(document.getElementById('bufferContainer'));"/></th>
					<th><input type="button" value="全選輸出文字" onclick="selectAllText(document.getElementById('resultContainer'));"></th>
				</tr>
			</thead>
			<tbody>
				<tr valign="top">
					<td><textarea id="bufferContainer" rows="1" cols="1" style="border: 1px solid #000000; width: 100%; height: 500px; resize: vertical;"></textarea></td>
					<td><textarea id="resultContainer" rows="1" cols="1" style="border: 1px solid #000000; width: 100%; height: 500px; resize: vertical;"></textarea></td>
				</tr>
			</tbody>
		</table>
	</body>
</html>
